{% extends "base.html" %}



{% block script %}
<script>

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    $(document).ready(function(){
        var query = getParameterByName('q');
        var tweetList = [];
        var nextTweetUrl;

        $(document.body).on("click",".retweetBtn",function(event){
            event.preventDefault()
            console.log("retweet clicked")
            var url = "/api" + $(this).attr("href")
            $.ajax({
                method: "GET",
                url: url,
                success: function(data){
                    attachTweet(data, true, true)
                    updateHashLinks();
                    console.log(data)
                },
                error: function(data){
                    console.log("error on retweet")
                    console.log(data)
                }
            })
        })
       

        function updateHashLinks(){
            $(".media-body").each(function(data){
                var hastagRegex = /(^|\s)#([\w\d-]+)/g
                var usernameRegex = /(^|\s)@([\w\d-]+)/g
                var currentHtml = $(this).html()
                var newText;
                newText = currentHtml.replace(hastagRegex, "$1<a href='/tags/$2/'>#$2</a>")
                newText = newText.replace(usernameRegex, "$1<a href='/$2/'>@$2</a>")
                $(this).html(newText)
                // create hashtag here 
            })
        }
        
        function attachTweet(tweetValue, prepend, retweet){
            var dateDisplay = tweetValue.date_display
            var tweetContent = tweetValue.content;
            var tweetUser = tweetValue.user;
            var tweetFormattedHTML;
            if (retweet && tweetValue.parent){
                // retweet
                var mainTweet = tweetValue.parent
                tweetFormattedHTML = "<div class=\"media\"><div class=\"media-body\"><span class='grey-color'>Retweet via " + tweetUser.username + " on " + dateDisplay + "</span><br/>" + mainTweet.content + "<br/> via <a href='" + mainTweet.user.url + "'>" + mainTweet.user.username + "</a> | " + mainTweet.date_display + " | " + "<a href='/tweet/" + mainTweet.id + "'>View</a> | " + "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet'>Retweet</a>" + "</div></div><hr/>"
            } else {
                // fresh tweet
                tweetFormattedHTML = "<div class=\"media\"><div class=\"media-body\">" + tweetContent + "<br/> via <a href='" + tweetUser.url + "'>" + tweetUser.username + "</a> | " + dateDisplay + " | " + "<a href='/tweet/" + tweetValue.id + "'>View</a> | " + "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet'>Retweet</a>" + "</div></div><hr/>"
            }
            
            if (prepend==true){
                $("#tweet-container").prepend(tweetFormattedHTML)
            } else {
                $("#tweet-container").append(tweetFormattedHTML)
            }
            
        }

        function parseTweets(){
            if (tweetList == 0) {
                $("#tweet-container").text("No tweets currently found.")
            } else {
                $.each(tweetList, function(key, value){
                    var tweetkey = key;
                    if (value.parent){
                        attachTweet(value, false, true)
                    } else {
                        attachTweet(value)
                    }
                    
                })
            }
        }


        function fetchTweets(url){
            console.log("fetching..")
            var fetchURL;
            if (!url) {
                fetchURL = "/api/tweet/"
            } else {
                fetchURL = url
            }
            $.ajax({
                url: fetchURL,
                data: {
                    "q": query
                },
                method: "GET",
                success: function(data){
                    //console.log(data)
                    tweetList = data.results
                    //console.log(data.next)
                    if (data.next){
                        console.log(data.next)
                        nextTweetUrl = data.next
                    } else {
                        $("#loadmore").css("display", "none")
                    }
                    

                    parseTweets();
                    updateHashLinks();
                },
                error: function(data){
                    console.log("error")
                    console.log(data)
                }
            })
        }
        fetchTweets()

        $("#loadmore").click(function(event){
            event.preventDefault
            if (nextTweetUrl) {
                //console.log("loadmore")
                //console.log(nextTweetUrl)
                fetchTweets(nextTweetUrl)
            }
            //load more items
        })

        var charsStart = 140;
        var charsCurrent = 0;
        $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>");

        $("#tweet-form textarea").keyup(function(event){
            //console.log(event.key, event.timeStamp)
            var tweetValue = $(this).val()
            charsCurrent = charsStart - tweetValue.length
            //console.log(charsCurrent)
            var spanChars = $("#tweetCharsLeft")
            spanChars.text(charsCurrent)

            if (charsCurrent > 0){
                //remove classes
                spanChars.removeClass("grey-color")
                spanChars.removeClass("red-color")
            } else if (charsCurrent == 0) {
                //add classes
                spanChars.removeClass("red-color")
                spanChars.addClass("grey-color")
            } else if (charsCurrent < 0) {
                //add red class
                spanChars.removeClass("grey-color")
                spanChars.addClass("red-color")
            }
        })

        $("#tweet-form").submit(function(event){
            event.preventDefault()
            console.log("submit pressed")
            var this_ = $(this)
            var formData = this_.serialize()
            if (charsCurrent >= 0) {
               $.ajax({
                    url: "/api/tweet/create/",
                    data: formData,
                    method: "POST",
                    success: function(data){
                        this_.find("input[type=text], textarea").val("")
                        attachTweet(data, true)
                        updateHashLinks();
                        //console.log(data)
                        //fetchTweets()
                        //tweetList = data
                        //parseTweets()
                    },
                    error: function(data){
                        console.log("error on submit click")
                        console.log(data.status + " " + data.statusText)
                        //console.log()
                    }
                }) 
            } else {
                console.log("cannot send, tweet too long.")
            }
            
        })

    });
</script>
{% endblock script %}

{% block content %}

    <div class="row">
        <div class="col-sm-3 col-xs-12" style=''>
            <h1>{{ request.user }}</h1>
        </div>
        <div class="col-sm-9">

            {% if not request.GET.q %}
                <div class="">

                    {% include "tweets/form.html" with form=create_form action_url=create_url btn_title="Tweet" form_id='tweet-form' %}
                    <hr/>
                </div>
            {% endif %}
        <div id="tweet-container">
                
        </div>
        <a href="#" id='loadmore'>Load More Tweets</a>
        </div>
    </div>
{% endblock content %}